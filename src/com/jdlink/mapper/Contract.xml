<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.ContractMapper">

    <resultMap id="ContractRM" type="Contract" autoMapping="true">
        <id property="contractId" column="contractId"/>
        <result property="contractType" column="contractType" javaType="com.jdlink.domain.ContractType"/>
        <result property="checkState" column="checkState" javaType="com.jdlink.domain.CheckState"/>
        <result property="contractId" column="contractId" javaType="String"/>
        <result property="modelName" column="modelName" javaType="String"/>
        <result property="year" column="year" javaType="String"/>
        <result property="period" column="period" javaType="String"/>
        <result property="modelName" column="modelName" javaType="String"/>
        <result property="contractContent" column="contractContent" javaType="String"/>
        <result property="modelVersion" column="modelVersion" javaType="String"/>
        <result property="content" column="content" javaType="String"></result>
        <result property="supplier" column="supplier" javaType="String"/>
        <result property="nowTime" column="nowTime" javaType="String"></result>
        <result property="city" column="city" javaType="String"></result>
        <result property="opinion" column="opinion" javaType="String"></result>
        <result property="companyName " column="companyName " javaType="String"></result>
        <result property="province" column="province " javaType="com.jdlink.domain.Province"></result>
        <result property="contactName" column="contactName" javaType="String"></result>
        <result property="telephone" column="telephone" javaType="String"></result>
        <result property="clientId" column="clientId" javaType="String"></result>
        <association property="salesmanName" column="clientId" select="getSalesmanName"/>
        <association property="ticketRateItem" column="ticketRateId" select="getTicketRateItem"></association>
        <collection property="hazardousList" select="getHazardous" column="contractId"
                    ofType="com.jdlink.domain.Hazardous" javaType="ArrayList"/>
        <collection property="quotationItemList" select="getQuotationItem" column="contractId"
                    ofType="com.jdlink.domain.QuotationItem" javaType="ArrayList"/>
        <collection property="client" select="getClient" column="clientId"
                    ofType="com.jdlink.domain.Client" javaType="Client"/>
        <collection property="supplier" select="getSupplier" column="suppierId"
                    ofType="com.jdlink.domain.Supplier" javaType="Supplier"/>
        <collection property="checkStateItem" column="checkStateId" select="getCheckStateItem"></collection>
    </resultMap>

    <!--查询状态字典-->
    <select id="getCheckStateItem" resultType="CheckStateItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{dataDictionaryItemId}
    </select>
    <!--查询客户-->
    <resultMap id="ClientRM" type="Client" autoMapping="true">
        <association property="ticketRateItem" column="ticketRateId" select="getTicketRateItem"/>
    </resultMap>
    <!--开票类型数据字典-->
    <select id="getTicketRateItem" resultType="TicketRateItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{ticketRateId}
    </select>
    <select id="getClient" resultMap="ClientRM">
        select * from  client where clientId=#{clientId};
    </select>
    <resultMap id="SupplierRM" type="Supplier">
        <association property="ticketRateItem" column="ticketRateId" select="getTicketRateItem"></association>
    </resultMap>
    <!--查询供应商-->
    <select id="getSupplier" resultMap="SupplierRM">
      select * from  t_supplier where supplierId=#{suppierId};
    </select>
    <select id="getPackageTypeItem" resultType="PackageTypeItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{packageTypeId}
    </select>
    <select id="getTransportItem" resultType="TransportItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{transportId}
    </select>
    <select id="getUnitDataItem" resultType="UnitDataItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{unitId}
    </select>
    <!--通过报价单查询危废信息-->
    <select id="getQuotationItem" resultMap="QuotationItemRM">
        select * from t_quotationitem where t_quotationitem.contractId=#{contractId} order by wastesCode;
    </select>
    <insert id="add" parameterType="Contract">
        insert into t_contract (contractId,contractType, companyName, clientId, contractVersion,
        checkState, beginTime, endTime, agreedQuantity,contactName,telephone,reviewer,reviewDepartment,
        reviewDate,isFreight,order1,province,city,bankName,bankAccount,ticketRate1,ticketRate2,logisticsQualification,beginQualification,endQualification,modelName,year,period,contractContent,contractName,modelVersion,nowTime,company1,content,suppierId,totalPrice,checkStateId,freightBearer,small,ticketRateId)
        values (#{contractId},#{contractType}, #{companyName}, #{client.clientId}, #{contractVersion},
        #{checkState}, #{beginTime}, #{endTime}, #{agreedQuantity}, #{contactName}, #{telephone}, #{reviewer},
        #{reviewDepartment}, #{reviewDate},#{isFreight},#{order1},#{province},#{city},#{bankName},#{bankAccount},#{ticketRate1},#{ticketRate2},#{logisticsQualification},#{beginQualification},#{endQualification},#{modelName},#{year},#{period},#{contractContent},#{contractName},#{modelVersion},NOW(),#{company1},#{content},#{supplier.supplierId},#{totalPrice},64,#{freightBearer},#{small},#{ticketRateItem.dataDictionaryItemId})
    </insert>
    <insert id="addEm" parameterType="Contract">
        insert into t_contract(contractId,contractType,
        companyName,checkState,telephone,bankName,bankAccount,area,companyLegal,companyAgent,clientLegal,clientAgent,address,thing,province,beginTime,nowTime,ticketRate1,contractVersion,city,endTime,modelName,company1,contactName,contractName)
        values
        (#{contractId},#{contractType},#{companyName},#{checkState},#{telephone},#{bankName},#{bankAccount},#{area},#{companyLegal},#{companyAgent},#{clientLegal},#{clientAgent},#{address},#{thing},#{province},#{beginTime},NOW(),#{ticketRate1},#{contractVersion},#{city},#{endTime},#{modelName},#{company1},#{contactName},#{contractName});
        <if test="hazardousList.size() > 0 ">
            <foreach collection="hazardousList" item="hazardous" index="index">
                insert into r_contractandhazardous(contractId,hazardousId) values (#{contractId}, #{hazardous.id});
                insert into t_hazardous(id,name,num) values (#{hazardous.id}, #{hazardous.name}, #{hazardous.num});
            </foreach>
        </if>
    </insert>

    <delete id="delete" parameterType="Contract">
        delete from t_contract where contractId;
    </delete>

    <select id="getByKeyword" resultType="Contract" parameterType="Contract">
        select * from t_contract where (contractId like  binary "%"#{0}"%" or checkState like binary "%"#{0}"%" or companyName like binary "%"#{0}"%"
        or city like binary "%"#{0}"%"  or province like binary  "%"#{0}"%" or contactName like binary "%"#{0}"%" or telephone like  binary  "%"#{0}"%" or beginTime like binary  "%"#{0}"%" or contractType like binary  "%"#{0}"%" )and contractType like  "%"#{1}"%";
    </select>
    <select id="getContent" parameterType="String" resultType="String">
    select content from t_contract where contractId=#{contractId};
</select>
    <select id="getByContractId" parameterType="String" resultMap="ContractRM">
        SELECT * FROM t_contract WHERE contractId = #{contractId} ;
    </select>
    <select id="getModel" parameterType="String" resultMap="ContractRM">
        select * from t_contract where contractId=#{contractId};
    </select>
    <select id="getModel2" parameterType="String" resultMap="ContractRM">
        select * from t_contract where modelName=#{modelName} and period!=""and year !="";
    </select>

    <select id="getSalesmanName" parameterType="String" resultType="String">
        select name from salesman where salesmanId in (select salesmanId from client where clientId=#{clientId});
    </select>

    <update id="update" parameterType="Contract">
        UPDATE t_contract SET companyName=#{companyName}, clientId=#{clientId}, isCompanyContract=#{isCompanyContract},
        area=#{area}, beginTime=#{beginTime}, endTime=#{endTime}, agreedQuantity=#{agreedQuantity},
        contactName=#{contactName}, telephone=#{telephone}, reviewer=#{reviewer}, reviewDepartment=#{reviewDepartment},
        reviewDate=#{reviewDate},contractType=#{contractType},province=#{province},city=#{city},order1=#{order1},contractVersion=#{contractVersion},bankName=#{bankName},bankAccount=#{bankAccount},ticketRate1=#{ticketRate1},logisticsQualification=#{logisticsQualification},beginQualification=#{beginQualification},endQualification=#{endQualification},modelName=#{modelName},year=#{year},period=#{period},contractContent=#{contractContent},companyLegal=#{companyLegal},companyAgent=#{companyAgent},clientLegal=#{clientLegal},companyAgent=#{companyAgent},address=#{address},contractName=#{contractName},modelVersion=#{modelVersion},nowTime=NOW(),suppierName=#{suppierName},totalPrice=#{totalPrice},company1=#{company1},content=#{content} WHERE contractId=#{contractId};
    </update>
    <update id="updateEm" parameterType="Contract">
UPDATE t_contract SET companyName=#{companyName},area=#{area},beginTime=#{beginTime},endTime=#{endTime},contactName=#{contactName},
telephone=#{telephone},contractType="Emergency",bankName=#{bankName},bankAccount=#{bankAccount},wasteName=#{wasteName},tonNumber=#{tonNumber},companyLegal=#{companyLegal},companyAgent=#{companyAgent},clientLegal=#{clientLegal},companyAgent=#{companyAgent},address=#{address},contractName=#{contractName}, nowTime=NOW() WHERE contractId=#{contractId};
</update>
    <update id="setCheckStateToExamine" parameterType="Contract">
        UPDATE t_contract SET checkState='ToExamine', nowTime=NOW() WHERE contractId=#{contractId};
    </update>

    <update id="setCheckStateKeeping" parameterType="Contract">
        UPDATE t_contract SET checkState='Keeping', nowTime=NOW() WHERE contractId=#{contractId};
    </update>
    <update id="updateFreight1" parameterType="String">
    update t_contract  set  isFreight='1', nowTime=NOW() where contractId=#{id}
</update>
    <update id="updateFreight2" parameterType="String">
    update t_contract  set  isFreight='0', nowTime=NOW() where contractId=#{id}
</update>
    <update id="setCheckStateInvalid" parameterType="Contract">
        UPDATE t_contract SET checkState='Invalid', nowTime=NOW() WHERE contractId=#{contractId};
    </update>
    <update id="toSubmit" parameterType="String">
        UPDATE t_contract SET checkStateId=63, nowTime=NOW() WHERE contractId=#{id} ;
    </update>
    <select id="list" resultMap="ContractRM">
        select * from t_contract order by year desc ;
    </select>
    <select id="list1" resultMap="ContractRM">
        select * from t_contract where contractType=#{name} and checkState!='Invalid'order by nowTime desc;
    </select>
    <select id="list2" resultMap="ContractRM">
        select * from t_contract where contractType=#{0} and checkState=#{1}order by nowTime desc;
    </select>
    <select id="getContractIdList" resultType="String">
        select contractId from t_contract;
    </select>
    <select id="listRate1">
        select rate1 from ticketrate1;
    </select>
    <select id="listRate2">
        select rate2 from ticketrate2;
    </select>
    <update id="cancel">
        update t_contract set checkStateId=69  where contractId=#{0}
    </update>
    <delete id="cancel1" parameterType="String">
        delete from  t_contract  where contractId=#{contractId}
    </delete>
    <update id="approval" parameterType="String">
        update t_contract set checkState="Keeping", nowTime=NOW() where contractId=#{contractId}
    </update>
    <select id="modelName" resultMap="ContractRM">
        select distinct modelName from t_contract where modelName like CONCAT('%',#{key},'%') and period!="";
    </select>
    <update id="back" parameterType="Contract">
        update t_contract set checkStateId=66,backContent=#{1} where contractId=#{0}
    </update>
    <update id="opinion" parameterType="Contract">
    update t_contract set opinion=#{1},checkStateId=68 where contractId=#{0};
</update>
    <select id="getHazardous" resultType="Hazardous">
        SELECT * FROM t_hazardous WHERE id in (
          SELECT r_contractandhazardous.hazardousId FROM r_contractandhazardous
          WHERE contractId=#{contractId});
    </select>

    <select id="countTemplate" resultType="int">
        select count(*) from t_contract where modelName != '' and year != '';
    </select>

    <select id="countManage" resultType="int">
        select count(*) from t_contract
        <where>
            <if test="contractIndex == 0"><!--危废合同-->
                and contractType = 'Wastes'
            </if>
            <if test="contractIndex == 1"><!--应急合同-->
                and contractType = 'Emergency'
            </if>
            <if test="contractIndex == 2"><!--物流合同-->
                and contractType = 'Logistics'
            </if>
        </where>
    </select>

    <select id="listPageTemplate" resultMap="ContractRM">
        select * from t_contract where modelName != '' and year != ''
        order by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="listPageManege" resultMap="ContractRM">
        select * from t_contract
        <where>
            <if test="contractIndex == 0"><!--危废合同-->
                and contractType = 'Wastes'
            </if>
            <if test="contractIndex == 1"><!--应急合同-->
                and contractType = 'Emergency'
            </if>
            <if test="contractIndex == 2"><!--物流合同-->
                and contractType = 'Logistics'
            </if>
        </where>
        order by  checkStateId=69,nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="count" resultType="int">
        SELECT COUNT(*) FROM t_contract;
    </select>
    <!--获取合同条目列表（包含理化性质）-->
    <select id="getQuotationItemList" resultMap="QuotationItemRM">
        select t_quotationitem.quotationItemId, t_quotationitem.wastesCode, t_quotationitem.wastesName, t_quotationitem.contractAmount,
          t_quotationitem.unitPriceTax, t_quotationitem.packageTypeId,
          t_contract.clientId, t_pr_sampleinfoanalysis.heat, t_pr_sampleinfoanalysis.ash, t_pr_sampleinfoanalysis.PH,
          water,chlorine,fluorine,phosphorus,sulfur
        from (t_quotationitem left join t_pr_sampleinfoanalysis
            on t_quotationitem.wastesName=t_pr_sampleinfoanalysis.wastesName
               and t_quotationitem.wastesCode=t_pr_sampleinfoanalysis.wastesCode
          left join t_contract on t_quotationitem.contractId=t_contract.contractId)
        where t_quotationitem.contractId in (select t_contract.contractId
                                             from t_contract where checkStateId!=69 or checkStateId is null )
        order by t_contract.nowtime desc;
    </select>

    <!--列出合同中的所有涉及到的业务员-->
    <select id="listSalesmanByContract" resultType="Salesman">
        SELECT * FROM salesman WHERE salesmanId IN (
        SELECT salesmanId FROM client WHERE clientId IN (
        SELECT DISTINCT clientId FROM t_contract WHERE clientId IS NOT NULL
        )
        )
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <!--列出合同中所有涉及到的业务员数量-->
    <select id="countSalesmanByContract" resultType="int">
        SELECT COUNT(*) FROM salesman WHERE salesmanId IN (
            SELECT salesmanId FROM client WHERE clientId IN (
            SELECT DISTINCT clientId FROM t_contract WHERE clientId IS NOT NULL
            )
        );
    </select>
    <!--获取所有合同数据-->
    <select id="getContractList" parameterType="String" resultMap="ContractRM">
        select * from t_contract where contractType='Wastes' and (DATE_FORMAT(beginTime,'%Y-%m-%d') like "%"#{year}"%"
        or DATE_FORMAT(beginTime,'%Y%m%d') like "%"#{year}"%")
        order by beginTime asc;
    </select>

    <select id="searchMonthData" resultMap="ContractRM">
        select * from t_contract
        <where>
            <if test="1 == 1 ">
                and contractType='Wastes'
            </if>
            <if test="startDate != null and startDate != ''">
                <![CDATA[ and DATE_FORMAT(beginTime,'%Y%m')  >= DATE_FORMAT(#{startDate},'%Y%m') ]]>
            </if>
            <if test="endDate != null and endDate != ''">
                <![CDATA[ and DATE_FORMAT(beginTime,'%Y%m')  <= DATE_FORMAT(#{endDate},'%Y%m') ]]>
            </if>
            <if test="salesmanName != null and salesmanName != ''">
                and clientId in (select clientId from client where salesmanId in (select salesmanId from salesman where
                name like "%"#{salesmanName}"%"))
            </if>
        </where>
        order by beginTime asc;
    </select>

    <!--根据月份获取合同数据-->
    <select id="getContractListByMonth" parameterType="String" resultMap="ContractRM">
        select * from t_contract
        where
        contractType='Wastes'and DATE_FORMAT(beginTime,'%Y%m') like "%"#{month}"%"
        order by beginTime asc;
    </select>

    <!--通过业务员编号和月份读取对应的合同列表-->
    <select id="getContractBySalesman" parameterType="String" resultMap="ContractRM">
        SELECT * FROM t_contract
        WHERE
        clientId in (SELECT clientId FROM client WHERE salesmanId=#{salesmanId} and contractType='Wastes')
        AND (DATE_FORMAT(beginTime,'%Y-%m-%d') like "%"#{month}"%"
        or DATE_FORMAT(beginTime,'%Y%m%d') like "%"#{month}"%")
        order by beginTime asc;
    </select>

    <select id="getContractByMonth" parameterType="String" resultMap="ContractRM">
        SELECT * FROM t_contract
        WHERE
        DATE_FORMAT(beginTime,'%Y%m') like "%"#{month}"%")
        order by beginTime asc;
    </select>

    <!--获取业务员所有的合同-->
    <select id="getAllContractBySalesmanId" resultMap="ContractRM">
        SELECT * FROM t_contract
        WHERE
        clientId in (SELECT clientId FROM client WHERE salesmanId=#{salesmanId}) and contractType='Wastes'
        order by beginTime asc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="getAllContractCountBySalesmanId" parameterType="String" resultType="int">
        SELECT count(*) FROM t_contract
        WHERE
        clientId in (SELECT clientId FROM client WHERE salesmanId=#{salesmanId}) and contractType='Wastes'
    </select>


    <!--高级查询-->
    <select id="search" parameterType="Contract" resultType="Contract">
        select * from t_contract
        <where>
            <if test="keyword != null and keyword != ''">
                and contractId like "%"#{keyword}"%" or company1 like "%"#{keyword}"%" or
                contractName like "%"#{keyword}"%" or telephone like "%"#{keyword}"%" or
                suppierName like "%"#{keyword}"%" or modelName="%"#{keyword}"%"
            </if>
            <if test="contractId != null and contractId != ''">
                and contractId LIKE "%"#{contractId}"%"
            </if>
            <if test="companyName != null and companyName != ''">
                and company1 LIKE "%"#{companyName}"%"
            </if>
            <if test="contractName != null and contractName != ''">
                and contractName LIKE "%"#{contractName}"%"
            </if>
            <if test="telephone != null and telephone != ''">
                and telephone LIKE "%"#{telephone}"%"
            </if>
            <if test="suppierName != null and suppierName != ''">
                and suppierName LIKE "%"#{suppierName}"%"
            </if>
            <if test="checkState != null and checkState != ''">
                and checkState = #{checkState}
            </if>
            <if test="beginTime != null and beginTime != ''">
                <![CDATA[  and DATE_FORMAT(t_contract.beginTime, '%Y-%m-%d %H:%T:%s') =
                        DATE_FORMAT(#{beginTime}, '%Y-%m-%d %H:%T:%s')   ]]>
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="getContractByClientId" parameterType="String" resultMap="ContractRM">
        select * from t_contract where clientId =#{clientId} and checkStateId != 69;
</select>

    <select id="searchModel" parameterType="Contract" resultType="Contract">
        select * from t_contract
        <where>
            <if test="keyword != null and keyword != ''">
                and modelName like "%"#{keyword}"%" or year like "%"#{keyword}"%"
            </if>
            <if test="modelName != null and modelName != ''">
                and modelName LIKE "%"#{modelName}"%"
            </if>
            <if test="year != null and year != ''">
                and year LIKE "%"#{year}"%"
            </if>
            <if test="checkState != null and checkState != ''">
                and checkState =#{checkState}
            </if>
            <if test="contractType != null and contractType != ''">
                and contractType =#{contractType}
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <select id="getByClientId" parameterType="String" resultType="Client">
        select * from  client where clientId=#{clientId};
    </select>
    <!--查询最新的非模板合同编号-->
    <select id="getNewestContractId" resultType="String">
        select contractId from  t_contract where  content is null order by nowTime desc;
    </select>
    <!--添加合同中的报价单明细1223-->
    <insert id="addQuotationItem" parameterType="QuotationItem">
        insert into t_quotationitem(contractId,clientId,wastesCode,wastesName,packageType,util,unitPriceTax,contractAmount,totalPrice,transport,supplierId,packageTypeList,remarks,packageTypeId,transportId,unitId,beginTime,endTime) values
         (#{contractId},#{client.clientId},#{wastesCode},#{wastesName},#{packageType},#{util},#{unitPriceTax},#{contractAmount},#{totalPrice},#{transport},#{supplier.supplierId},#{packageTypeList},#{remarks},#{packageTypeItem.dataDictionaryItemId},#{transportItem.dataDictionaryItemId},#{unitDataItem.dataDictionaryItemId},#{beginTime},#{endTime});
    </insert>
    <!--根据供应商编号查询供应商-->
    <select id="getSupplierListById" parameterType="String" resultType="Supplier">
        select * from t_supplier where supplierId=#{supplierId};
    </select>

    <!--更行合同信息==》主表更新-->
    <update id="updateContract" parameterType="Contract">
        update t_contract set bankAccount=#{bankAccount},bankName=#{bankName},
        beginTime=#{beginTime},clientId=#{client.clientId},contactName=#{contactName},
        contractName=#{contractName},contractType=#{contractType},contractVersion=#{contractVersion},
        endTime=#{endTime},isFreight=#{freight},telephone=#{telephone},ticketRate1=#{ticketRate1},totalPrice=#{totalPrice},freightBearer=#{freightBearer},ticketRateId=#{ticketRateItem.dataDictionaryItemId},contractId=#{newId},small=#{small}

        where  contractId=#{contractId}
    </update>
    <!--删除字表的明细-->
    <delete id="deleteQuotationItem" parameterType="String">
        delete from t_quotationitem where  contractId=#{contractId};
    </delete>
    <!--更新合同字表-->
    <!--<update id="updateQuotationItem" parameterType="QuotationItem">-->
    <!--insert into t_quotationitem(contractId,clientId,wastesCode,wastesName,packageType,util,unitPriceTax,contractAmount,totalPrice,transport,supplierId) values-->
    <!--(#{contractId},#{client.clientId},#{wastesCode},#{wastesName},#{packageType},#{util},#{unitPriceTax},#{contractAmount},#{totalPrice},#{transport},#{supplier.supplierId});-->
    <!--</update>-->

    <!--获得最新的合同编号-->
    <select id="getNewestContractId1" resultType="int">
        select count(*) from  t_contract;
    </select>

    <select id="getWastesInfoByCompanyName" resultMap="ContractRM">
        select * from t_contract
        where clientId in (select clientId from client where companyName =#{companyName})
        and checkStateId=172 and <![CDATA[ DATE_FORMAT(endTime, '%Y-%m-%d') >= DATE_FORMAT(#{creationDate}, '%Y-%m-%d')
        and DATE_FORMAT(beginTime, '%Y-%m-%d') <=  DATE_FORMAT(#{creationDate}, '%Y-%m-%d') ]]>;
    </select>

    <select id="getContractByCompanyName" parameterType="String" resultMap="ContractRM">
        select * from t_contract
        where clientId in (select clientId from client where companyName =#{companyName});
    </select>

    <!--获取最新的合同数据(不分合同类别)==>合约量统计-->
    <resultMap id="QuotationItemRM" type="QuotationItem">
        <result property="heat" column="heat"/>
        <result property="ash" column="ash"/>
        <result property="ph" column="PH"/>
        <result property="waterContent" column="water"/>
        <result property="sulfurContent" column="sulfur"/>
        <result property="chlorineContent" column="chlorine"/>
        <result property="fluorineContent" column="fluorine"/>
        <result property="phosphorusContent" column="phosphorus"/>
        <result property="startDate" column="startDate"/>
        <association property="contract" column="contractId" select="getContractById"/>
        <association property="client" column="clientId" select="getClient"/>
        <collection property="packageTypeItem" column="packageTypeId" select="getPackageTypeItem"/>
        <collection property="transportItem" column="transportId" select="getTransportItem"/>
        <collection property="unitDataItem" column="unitId" select="getUnitDataItem"/>
    </resultMap>

    <select id="getContractById" resultType="Contract">
        select * from t_contract where contractId=#{contractId};
    </select>

    <select id="contractVolume" resultType="int">
      select  count(*) from t_quotationitem  where
      t_quotationitem.contractId in(select contractId from t_contract where  contractType is NOT  NULL  and period is NULL and contractContent is NULL  and  modelVersion is null);
    </select>

    <select id="ContractList" resultMap="QuotationItemRM">
        select * from t_quotationitem where t_quotationitem.contractId in(select contractId from t_contract where
        contractType is NOT NULL and period is NULL and contractContent is NULL and modelVersion is null and checkStateId!=69)

        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <!--根据签订日期范围查询合同明细:统计图表-->
    <select id="getQuotationItemByRange" resultMap="QuotationItemRM">
        select SUM(a.contractAmount) as contractAmount,b.beginTime as startDate from t_quotationitem as a left join t_contract as b
        on a.contractId=b.contractId
        <where>
            <if test="startDate != null and startDate != ''">
            <![CDATA[AND DATE_FORMAT(b.beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')]]>
            </if>
            <if test="endDate != null and endDate != ''">
            <![CDATA[AND DATE_FORMAT(b.beginTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>
            </if>
            <if test="1==1">
                AND b.checkStateId != 69
            </if>
        </where>
        GROUP BY DATE_FORMAT(b.beginTime, '%Y%m') ORDER BY b.beginTime ASC;
    </select>

    <!--插入文件-->
    <update id="setFilePath" parameterType="QuotationItem">
        <if test="picture != null and picture != ''">
            UPDATE t_quotationitem SET picture=#{picture} WHERE contractId=#{contractId} and wastesName=#{wastesName}
            and wastesCode=#{wastesCode};
            INSERT INTO t_document (contractId, filePath, documentType) VALUES (#{contractId}, #{picture},'Contract');
        </if>
    </update>

    <!--插入合同附件-->
    <update id="setContractFilePath" parameterType="Contract">
        <if test="contractAppendicesUrl != null and contractAppendicesUrl != ''">
            UPDATE t_contract SET contractAppendicesUrl=#{contractAppendicesUrl} WHERE contractId=#{contractId};
            INSERT INTO t_document (contractId, filePath, documentType) VALUES (#{contractId},
            #{contractAppendicesUrl},'Contract');
        </if>
    </update>

    <!--更新危废图片路径-->
    <update id="updatePictureUrl">
        update t_quotationitem set picture=#{3} where wastesCode=#{0} and wastesName=#{1} and
        contractId=#{2}
    </update>

    <!--合同合约量页面查询-->
    <select id="searchContractVolume" resultMap="QuotationItemRM" parameterType="QuotationItem">
        select * from t_quotationitem
        <where>
        <if test="keywords!=null and keywords!=''">
         or clientId in(select clientId from client where companyName like "%"#{keywords}"%")
          or wastesName like "%"#{keywords}"%"
            or wastesCode like "%"#{keywords}"%"
           or contractAmount =#{keywords}
            or unitPriceTax =#{keywords}
            or totalPrice =#{keywords}
            or beginTime like binary"%"#{keywords}"%"
            or endTime like binary"%"#{keywords}"%"
        </if>
        <if test="client!=null">
                             <if test="client.companyName!=''">
                                and clientId in(select clientId from client where companyName like "%"#{client.companyName}"%")
                             </if>

                         </if>
        <if test="beginTime!=null">
            <![CDATA[
                and beginTime >= #{beginTime}
                ]]>
        </if>
            <if test="wastesName!=null and wastesName!=''">
                and wastesName like "%"#{wastesName}"%"
            </if>
            <if test="wastesCode!=null and wastesCode!=''">
                and wastesCode like "%"#{wastesCode}"%"
            </if>
        <if test="endTime!=null">
            <![CDATA[
                and endTime <= #{endTime}
                ]]>
        </if>
            and contractId is not null
        </where>
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <select id="searchContractVolumeCount" resultType="int" parameterType="QuotationItem">
        select count(*) from t_quotationitem
        <where>
            <if test="keywords!=null and keywords!=''">
                or clientId in(select clientId from client where companyName like "%"#{keywords}"%")
                or wastesName like "%"#{keywords}"%"
                or wastesCode like "%"#{keywords}"%"
                or contractAmount =#{keywords}
                or unitPriceTax =#{keywords}
                or totalPrice =#{keywords}
                or beginTime like binary"%"#{keywords}"%"
                or endTime like binary"%"#{keywords}"%"
            </if>
            <if test="client!=null">
                <if test="client.companyName!=''">
                    and clientId in(select clientId from client where companyName like "%"#{client.companyName}"%")
                </if>

            </if>
            <if test="wastesName!=null and wastesName!=''">
                and wastesName like "%"#{wastesName}"%"
            </if>
            <if test="wastesCode!=null and wastesCode!=''">
                and wastesCode like "%"#{wastesCode}"%"
            </if>
            <if test="beginTime!=null">
                <![CDATA[
                and beginTime >= #{beginTime}
                ]]>
            </if>

            <if test="endTime!=null">
                <![CDATA[
                and endTime <= #{endTime}
                ]]>
            </if>
            and contractId is not null
        </where>
    </select>

    <!--审批合同模板-->
  <update id="approvalModel" parameterType="String">
      update t_contract set checkStateId=70 where contractId=#{contractId}
  </update>


    <!--签订合同-->
    <update id="signContract" parameterType="String">
        update t_contract set  checkStateId=172 where contractId=#{contractId}
    </update>

    <!--获取所有的合同编号-->
    <select id="getAllContractId" resultType="String">
        select contractId from t_contract;
    </select>

    <!--加载危废合同-->
    <select id="loadPageWastesContractList" resultMap="ContractRM">
        select  * from  t_contract where contractType='Wastes' and period is  null and checkStateId != 69 order  by  nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <!--加载应急合同-->
    <select id="loadPageEmergencyContractList" resultMap="ContractRM">
        select  * from  t_contract where contractType='Emergency' and period is  null and checkStateId != 69 order  by  nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <!--加载物流合同-->
    <select id="loadPageLogisticsContractList" resultMap="ContractRM">
        select  * from  t_contract where contractType='Logistics' and period is  null and checkStateId != 69 order  by  nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>
    <!--危废合同总数-->
    <select id="loadPageWastesContractListCount" resultType="int">
        select count(*)  from  t_contract where contractType='Wastes' and period is  null and checkStateId != 69;
    </select>

    <!--应急合同总数-->
    <select id="loadPageEmergencyContractListCount" resultType="int">
        select count(*)  from  t_contract where contractType='Emergency' and period is  null and checkStateId != 69;
    </select>

    <!--物流合同总数-->
    <select id="loadPageLogisticsContractListCount" resultType="int">
                select count(*)  from  t_contract where contractType='Logistics' and period is  null and checkStateId != 69;
    </select>

    <!--危废合同查询-->
    <select id="searchWasteContract" resultMap="ContractRM" parameterType="Contract">
        select  * from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or reviewer like binary"%"#{keyword}"%"
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )
                and contractType='Wastes'and period is  null
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Wastes'and period is  null
            </if>
        </where>
        order  by  nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--应急合同查询-->
    <select id="searchEmergencyContract" resultMap="ContractRM" parameterType="Contract">
        select  * from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or reviewer like binary"%"#{keyword}"%"
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )
                and contractType='Emergency' and period is null order by nowTime desc
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Emergency' and period is  null  order  by  nowTime desc
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--物流合同查询-->
    <select id="searchLogisticsContract" resultMap="ContractRM" parameterType="Contract">
        select  * from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or reviewer like binary"%"#{keyword}"%"
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )and contractType='Logistics' and period is null order by nowTime desc
            </if>

            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Logistics' and period is  null  order  by  nowTime desc
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--危废合同查询总数-->
    <select id="searchWasteContractCount" resultType="int">
        select  count(*) from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or reviewer like binary"%"#{keyword}"%"
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )
                and contractType='Wastes'and period is  null
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Wastes'and period is  null
            </if>
        </where>

    </select>

    <!--应急合同查询总数-->
    <select id="searchEmergencyContractCount" resultType="int">
        select  count(*) from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or reviewer like binary"%"#{keyword}"%"
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )
                and contractType='Emergency' and period is null order by nowTime desc
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Emergency' and period is  null  order  by  nowTime desc
            </if>
        </where>
    </select>

    <!--物流合同查询总数-->
    <select id="searchLogisticsContractCount" resultType="int">
        select  count(*) from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or reviewer like binary"%"#{keyword}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )and contractType='Logistics' and period is null order by nowTime desc
            </if>

            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Logistics' and period is  null  order  by  nowTime desc
            </if>
        </where>
    </select>

    <!--次生合同总数-->
    <select id="loadPageDeriveContractListCount" resultType="int">
                        select count(*)  from  t_contract where contractType='Derive' and period is  null and checkStateId != 69;
    </select>

    <!--加载次生合同-->
    <select id="loadPageDeriveContractList" resultMap="ContractRM">
        select  * from  t_contract where contractType='Derive' and period is  null and checkStateId != 69 order  by  nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>


    <!--次生合同查询-->
    <select id="searchDeriveContract" resultMap="ContractRM" parameterType="Contract">
        select  * from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or small like binary#{keyword}
                or reviewer like binary"%"#{keyword}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )and contractType='Derive' and period is null order by nowTime desc
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Derive' and period is  null  order  by  nowTime desc
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--次生合同查询计数-->
    <select id="searchDeriveContractCount" resultType="int">
        select  count(*) from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or reviewer like binary"%"#{keyword}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )and contractType='Derive' and period is null order by nowTime desc
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Derive' and period is  null  order  by  nowTime desc
            </if>
        </where>
    </select>

    <!--采购合同总数-->
    <select id="loadPagePurchaseContractListCount" resultType="int">
                        select count(*)  from  t_contract where contractType='Purchase' and period is  null and checkStateId != 69;
    </select>

    <!--加载采购合同-->
    <select id="loadPagePurchaseContractList" resultMap="ContractRM">
        select  * from  t_contract where contractType='Purchase' and period is  null and checkStateId != 69 order  by  nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <!--采购合同查询-->
    <select id="searchPurchaseContract" resultMap="ContractRM" parameterType="Contract">
        select  * from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or reviewer like binary"%"#{keyword}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )and contractType='Purchase' and period is null order by nowTime desc
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Purchase' and period is  null  order  by  nowTime desc
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--采购合同查询计数-->
    <select id="searchPurchaseContractCount" resultType="int">
        select  count(*) from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or small like binary#{keyword}
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or reviewer like binary"%"#{keyword}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )and contractType='Purchase' and period is null order by nowTime desc
            </if>

            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Purchase' and period is  null  order  by  nowTime desc
            </if>
        </where>
    </select>


    <!--其他合同总数-->
    <select id="loadPageOtherContractListCount" resultType="int">
                        select count(*)  from  t_contract where contractType='Other' and period is  null and checkStateId != 69;
    </select>

    <!--加载其他合同-->
    <select id="loadPageOtherContractList" resultMap="ContractRM">
        select  * from  t_contract where contractType='Other' and period is  null and checkStateId != 69 order  by  nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <!--其他合同查询-->
    <select id="searchOtherContract" resultMap="ContractRM" parameterType="Contract">
        select  * from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and (contractId like binary"%"#{keyword}"%"
                or clientId in(select clientId from client where companyName like binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like binary"%"#{keyword}"%")
                or beginTime like binary"%"#{keyword}"%"
                or endTime like binary"%"#{keyword}"%"
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or small like binary#{keyword}
                or reviewer like binary"%"#{keyword}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keyword}"%" and dataDictionaryId=11)
                )and contractType='Other' and period is null order by nowTime desc
            </if>

            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Other' and period is  null  order  by  nowTime desc
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--其他合同查询计数-->
    <select id="searchOtherContractCount" resultType="int">
        select  count(*) from t_contract
        <where>
            <if test="keyword!='' and keyword!=null">
                and ( contractId like binary"%"#{keyword}"%"
                or  clientId in(select clientId from client where companyName like  binary"%"#{keyword}"%")
                or contractName like binary"%"#{keyword}"%"
                or contactName in (select contactName from client where contactName like  binary"%"#{keyword}"%")
                or beginTime   like binary"%"#{keyword}"%"
                or  endTime   like   binary"%"#{keyword}"%"
                or small  like  binary#{keyword}
                or contractId in(select contractId from  t_quotationitem where wastesName = #{keyword})
                or reviewer  like   binary"%"#{keyword}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like "%"#{keyword}"%" and  dataDictionaryId=11)
                )and contractType='Other' and period is  null  order  by  nowTime desc
            </if>

            <if test="checkStateItem!=null">
                <if test="checkStateItem.dataDictionaryItemId!=0">
                    and checkStateId=#{checkStateItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="client!=null">
                <if test="client.companyName!=null and client.companyName!=''">
                    and clientId in(select clientId from  client where companyName=#{client.companyName})
                </if>
                <if test="client.contactName!=null and client.contactName!=''">
                    and clientId in(select clientId from  client where contactName=#{client.contactName})
                </if>
            </if>
            <if test="quotationItemList.size()>0">
                <if test="quotationItemList[0].wastesName!=null and quotationItemList[0].wastesName!=''">
                    and contractId in(select contractId from  t_quotationitem where wastesName = #{quotationItemList[0].wastesName})
                </if>
            </if>
            <if test="small!=null" >
                and small=#{small}
            </if>
            <if test="beginTime!=null">
                <![CDATA[ and DATE_FORMAT(beginTime, '%Y-%m-%d') >=  DATE_FORMAT(#{beginTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="endTime!=null">
                <![CDATA[ and DATE_FORMAT(endTime, '%Y-%m-%d') <=  DATE_FORMAT(#{endTime}, '%Y-%m-%d') ]]>
            </if>
            <if test="keyword==''">
                and contractType='Other' and period is  null  order  by  nowTime desc
            </if>
        </where>
    </select>
</mapper>



