<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jdlink.mapper.CompatibilityMapper"  >
    <resultMap id="CompatibilityRM" type="Compatibility" autoMapping="true">
        <result property="pwId" column="pwId"  ></result>
        <result property="handleCategory" column="handleCategory" javaType="HandleCategory"></result>
        <result property="formType" column="formType" javaType="FormType"></result>
        <result property="calorific" column="calorific" ></result>
        <result property="ash" column="ash" ></result>
        <result property="water" column="water" ></result>
        <result property="S" column="S"></result>
        <result property="CL" column="CL" ></result>
        <result property="P" column="P" ></result>
        <result property="F" column="F" ></result>
        <result property="PH" column="PH" ></result>
        <result property="dailyProportionsTotal" column="dailyProportionsTotal" ></result>
        <result property="weeklyDemandTotal" column="weeklyDemandTotal" ></result>
        <result property="calorificTotal" column="calorificTotal"></result>
        <result property="proportion" column="proportion"></result>
        <result property="checkState" column="checkState" javaType="CheckState"></result>
        <result property="weeklyDemand" column="weeklyDemand" ></result>
        <collection property="wastesList" select="getWastes" column="compatibilityId" ofType="com.jdlink.domain.Wastes" javaType="ArrayList"/>
    </resultMap>
    <select id="getWastes" resultType="Wastes">
        SELECT * FROM t_wastes WHERE compatibilityId in (
          SELECT t_pr_pw.compatibilityId FROM t_pr_pw
          WHERE t_wastes.compatibilityId=#{compatibilityId});
    </select>

    <select id="total" resultType="int">
        SELECT COUNT(*) FROM t_pr_pw;
    </select>
    <select id="getByCompatibilityId" parameterType="String" resultMap="CompatibilityRM">
  SELECT * FROM t_pr_pw WHERE pwId = #{pwId}
    </select>
    <select id="getLastId" resultType="int">
        select count(*) from t_pr_pw;
    </select>
    <!--查找配伍编号-->
    <select id="check" resultType="String">
        select compatibilityId from  t_pr_pw order by compatibilityId desc ;
    </select>
    <select id="check1" resultType="String">
        select compatibilityId from  t_pr_pw  where nowTime!="" order by nowTime desc ;
    </select>
    <select id="list" parameterType="String" resultMap="CompatibilityRM">
        select * from t_pr_pw where compatibilityId=#{compatibilityId} order by nowTime desc ;
    </select>
    <update id="approval" >
        update t_pr_pw set checkState='Keeping',approvalContent=#{1},nowTime=NOW() where pwId=#{0};
    </update>
    <update id="back" >
        update t_pr_pw set checkState='Backed',backContent=#{1},nowTime=NOW() where pwId=#{0};
    </update>
    <select id="getByPwId1" resultMap="CompatibilityRM" parameterType="String">
        select * from t_pr_pw where pwId=#{pwId};
    </select>
    <update id="cancel" parameterType="String">
        update t_pr_pw set checkState='Invalid',nowTime=NOW() where compatibilityId=#{compatibilityId}
    </update>

    <update id="submit" parameterType="String">
        update t_pr_pw set checkState='ToExamine',nowTime=NOW() where compatibilityId=#{compatibilityId}
    </update>

    <update id="approvalCompatibility" parameterType="String">
        update t_pr_pw set checkState='Approval',nowTime=NOW() where compatibilityId=#{compatibilityId}
    </update>

    <select id="search" parameterType="Compatibility" resultMap="CompatibilityRM">
        select * from t_pr_pw
        <where>
            <if test="keyword != null and keyword != '' or keyword == ''">
                and  (pwId like "%"#{keyword}"%"
                or dailyProportions like "%"#{keyword}"%" or weeklyDemand like "%"#{keyword}"%"
                or calorific like "%"#{keyword}"%" or ash like "%"#{keyword}"%"  or water like "%"#{keyword}"%"
                or cl like "%"#{keyword}"%"  or s like "%"#{keyword}"%"  or p like "%"#{keyword}"%"
                or f like "%"#{keyword}"%"  or ph like "%"#{keyword}"%") and compatibilityId=#{compatibilityId}
            </if >
            <if test="pwId != null and pwId != ''">
                and pwId LIKE "%"#{pwId}"%"
            </if>

            <if test="dailyProportions != null and dailyProportions != ''">
                and dailyProportions LIKE "%"#{dailyProportions}"%"
            </if>
            <if test="weeklyDemand != null and weeklyDemand != ''">
                and weeklyDemand LIKE "%"#{weeklyDemand}"%"
            </if>
            <if test="calorific != null and calorific != ''">
                and calorific LIKE "%"#{calorific}"%"
            </if>
            <if test="ash != null and ash != ''">
                and pwId LIKE "%"#{pwId}"%"
            </if>
            <if test="ash != null and ash != ''">
                and ash LIKE "%"#{ash}"%"
            </if>
            <if test="water != null and water != ''">
                and water LIKE "%"#{water}"%"
            </if>
            <if test="CL != null and CL != ''">
                and cl LIKE "%"#{CL}"%"
            </if>
            <if test="s != null and s != ''">
                and S LIKE "%"#{s}"%"
            </if>
            <if test="P != null and P != ''">
                and p LIKE "%"#{P}"%"
            </if>
            <if test="F != null and F != ''">
                and f LIKE "%"#{F}"%"
            </if>
            <if test="P != null and P != ''">
                and p LIKE "%"#{P}"%"
            </if>
            <if test="PH != null and PH != ''">
                and ph LIKE "%"#{PH}"%"
            </if>
            <if test="handleCategory != null and handleCategory != ''">
                and handleCategory=#{handleCategory}
            </if>
            <if test="formType != null and formType != ''">
                and formType=#{formType}
            </if>
            <if test="compatibilityId != null and compatibilityId != ''">
                and compatibilityId=#{compatibilityId}
            </if>
            <if test="checkState != null and checkState != ''">
                and checkState=#{checkState}
            </if>
        </where>
    </select>
    <!--<insert id="add" parameterType="Compatibility">-->
    <!--insert into  t_pr_pw(pwId, handleCategory, formType, proportion, dailyProportions, weeklyDemand, calorific, CL, P, F, PH, water, endTime, dailyProportionsTotal, beginTime, calorificTotal, checkState, ash, weeklyDemandTotal, S, nowTime, compatibilityId, approvalContent, backContent)-->
     <!--values (#{pwId},#{handleCategory},#{formType},#{proportion},#{dailyProportions},#{weeklyDemand},#{calorific},#{CL},#{P},#{F},#{PH},#{water},#{endTime},#{dailyProportionsTotal},#{beginTime},#{calorificTotal},'ToExamine',#{ash},#{weeklyDemandTotal},#{S},NOW(),#{compatibilityId},#{approvalContent},#{backContent})-->
    <!--</insert>-->
    <insert id="add" parameterType="Compatibility">
    insert into  t_pr_pw(pwId,handleCategory,formType,proportion,dailyProportions,weeklyDemand,beginTime,endTime,compatibilityId,nowTime,checkState)
        values (#{pwId},#{handleCategory},#{formType},#{proportion},#{dailyProportions},#{weeklyDemand},#{beginTime},#{endTime},#{compatibilityId},Now(),'ToExamine');
        <foreach collection="wastesList"  item="wastes" index="index">
            insert into t_wastes(id,calorific,ashPercentage,wetPercentage,chlorinePercentage,sulfurPercentage,phosphorusPercentage,fluorinePercentage,ph,compatibilityId) values
            (#{wastes.id},#{wastes.calorific},#{wastes.ashPercentage},#{wastes.wetPercentage},#{wastes.chlorinePercentage},#{wastes.sulfurPercentage},#{wastes.phosphorusPercentage},#{wastes.fluorinePercentage},#{wastes.ph},#{compatibilityId});
        </foreach>
    </insert>

    <!--添加配伍计划单的明细-->
    <insert id="addCompatibilityItem" parameterType="CompatibilityItem">
        insert into t_pr_pwitem(compatibilityId, handleCategory, formType, proportion, dailyRatio, weeklyDemandTotal, calorific, ash, water, cl, s, p, f, ph) values
        (#{compatibilityId},#{handleCategory},#{formType},#{proportion},#{dailyRatio},#{weeklyDemandTotal},#{calorific},#{ash},#{water},#{cl},#{s},#{p},#{f},#{ph});
    </insert>
    <!--添加配伍周计划主表-->
    <insert id="addCompatibility" parameterType="Compatibility">
        insert into t_pr_pw(compatibilityId, totalDailyAmount, checkState, nowTime,  approvalContent, backContent, calorificAvg, ashAvg, waterAvg, clAvg, sAvg, phAvg, importDate, weeklyDemandTotalAggregate,fAvg,pAvg) values
        (#{compatibilityId},#{totalDailyAmount},'ToSubmit',NOW(),#{approvalContent},#{backContent},#{calorificAvg},#{ashAvg},#{waterAvg},#{clAvg},#{sAvg},#{phAvg},NOW(),#{weeklyDemandTotalAggregate},#{fAvg},#{pAvg})
    </insert>
    <resultMap id="WeekPlan" type="Compatibility" autoMapping="true">
        <result column="compatibilityId" property="compatibilityId"></result>
        <collection property="compatibilityItemList" column="compatibilityId" select="getCompatibilityItem"></collection>
    </resultMap>
    <!--获取明细-->
    <select id="getCompatibilityItem" resultType="CompatibilityItem">
        select * from t_pr_pwitem where compatibilityId=#{compatibilityId};
    </select>
    <select id="getWeekPlanList" resultMap="WeekPlan">
        select * from t_pr_pw order by nowTime desc ;
    </select>

    <!--根据配伍编号获取明细-->
    <select id="getWeekById" parameterType="String" resultType="CompatibilityItem">
        select * from  t_pr_pwitem where compatibilityId=#{compatibilityId};
    </select>

    <!--更新配伍周计划明细-->
    <update id="updateCompatibilityItem" parameterType="CompatibilityItem">
        update t_pr_pwitem set handleCategory=#{handleCategory},formType=#{formType},
        proportion=#{proportion},dailyRatio=#{dailyRatio},weeklyDemandTotal=#{weeklyDemandTotal},
        calorific=#{calorific},ash=#{ash},water=#{water},cl=#{cl},p=#{p},f=#{f},ph=#{ph}
        where id=#{id}
    </update>
    <!--更新配伍周计划-->
    <update id="updateCompatibility" parameterType="Compatibility">
        update t_pr_pw set totalDailyAmount=#{totalDailyAmount},calorificAvg=#{calorificAvg},
        ashAvg=#{ashAvg},waterAvg=#{waterAvg},clAvg=#{clAvg},sAvg=#{sAvg},phAvg=#{phAvg},
        weeklyDemandTotalAggregate=#{weeklyDemandTotalAggregate},fAvg=#{fAvg},pAvg=#{pAvg},nowTime=NOW()
        where compatibilityId=#{compatibilityId};
    </update>

</mapper>